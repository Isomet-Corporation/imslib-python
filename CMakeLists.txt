cmake_minimum_required(VERSION 3.15)

message(STATUS "Building for Platform: '${CMAKE_GENERATOR_PLATFORM}'")
cmake_policy(SET CMP0091 NEW) # Required to avoid Conan toolchain error on Windows

project(imslib_swig)

# Use C++17 or later
set(CMAKE_CXX_STANDARD 17)

# Locate Python and SWIG
find_package(Python3 3.4 COMPONENTS Interpreter Development REQUIRED)
if(Python3_FOUND)
  # Override Python3_LIBRARIES to point to the stable ABI lib
  set(Python3_LIBRARIES python3)

  message(STATUS "Found Python3 at ${Python3_EXECUTABLE}")
  message(STATUS "Python3_LIBRARIES: ${Python3_LIBRARIES}")
  message(STATUS "Python3_LIBRARY_DIRS: ${Python3_LIBRARY_DIRS}")
else()
  message(FATAL_ERROR "No Python3 installation found")
endif()

find_package(SWIG 4.0 COMPONENTS python REQUIRED)
if(SWIG_FOUND)
  message(STATUS "SWIG found: ${SWIG_EXECUTABLE}")
  if(NOT SWIG_python_FOUND)
    message(WARNING "SWIG Python bindings cannot be generated")
  endif()
endif()

include(${SWIG_USE_FILE})

set(SWIG_MODULE_NAME imslib)

# The underlying C++ Library
set(IMS_LIB_SUBMODULE ims-lib)

## iMS Dependencies generated by conan
include(${CMAKE_BINARY_DIR}/generators/conan_toolchain.cmake) # Conan Toolchain (CMakeToolchain)
##
## Check for LibXML2
##
find_package(LibXml2 2.9.9 REQUIRED)
if (LibXml2_FOUND)
    message("-- Including LibXml2")
    include_directories(${libxml2_INCLUDE_DIRS})
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${libxml2_DEFINITIONS}")
else()
    message("-- LibXml2 not Found")
endif()

##
## Get BOOST
##
find_package(Boost REQUIRED)

# Set source and include directories
include_directories(
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${Python3_INCLUDE_DIRS}
    ${CMAKE_CURRENT_SOURCE_DIR}/${IMS_LIB_SUBMODULE}/include
)

# Define the SWIG module
set(SWIG_INTERFACE swig/imslib.i)

set_property(SOURCE ${SWIG_INTERFACE} PROPERTY CPLUSPLUS ON)

set (UseSWIG_TARGET_NAME_PREFERENCE STANDARD)
swig_add_library(${SWIG_MODULE_NAME}
    TYPE SHARED
    LANGUAGE python
    SOURCES ${SWIG_INTERFACE}
) 

# Add iMS Library directly to this module
set(IMS_TARGET_NAME ${SWIG_MODULE_NAME})
add_subdirectory(${IMS_LIB_SUBMODULE})

target_link_directories(${SWIG_MODULE_NAME} PRIVATE ${Python3_LIBRARY_DIRS})
target_link_libraries(${SWIG_MODULE_NAME} PRIVATE ${Python3_LIBRARIES} ${IMS_LIBRARY_NAME})
